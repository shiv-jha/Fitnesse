---
Test
---
!define fileType {TRR}
!define contract {R4010}
!define hicnum1 {271266289A}
!define hicnum2 {445469610A}
!define fst_nm1 {WILLIAG}
!define fst_nm2 {LARRYG}


!define contents {${hicnum1}  WHITAKES    ${fst_nm1} 119290116T${contract}46260    03511 20160730 001 20160904020160930                       ${contract}           03                             03.37.45.209556                                                                                                                                                                                            MEMB DECEASED                                                                                                -1089303039               
${hicnum2}  SMITH       ${fst_nm2}  119470718T${contract}46260    03621Y201607310001 20160904020160930                       ${contract}             N   00021.5000017.50S   026  03.38.46.633529                                                                      0008.90 0000.00 0000.00 0000.00                                                                    0000.00            AUTO DISENROLL 08                                                                                            -1089290038              0
}


!define env {TST}

!|script  |File Support             |
|$current=|make id using Time|yyMMdd|

!|script                  |File Support                 |
|$currentdateverification=|make id using Time|yyyy-MM-dd|

!*> 1. !style_green('''This step will FTP the file into inbound directory)
!|script          |File Support                                                                     |
|$currentdatetime=|make id using Time                             |yyyyMMddHHmmss                   |
|given the        |P.R${contract}.D${fileType}D.D$current.T0103014|trr file with content|${contents}|
*!

|Library                                                                                     |
|!-com.optum.hde.fitnesse.fixtures.DatabaseSupport-!|${DW_DB_URL}|${DW_DB_USER}|${DW_DB_PASS}|


!|script     |EtlJobRunner                                                                                              |
|$job_status=|run Job With|${etl_ui_user}|User|${etl_ui_pwd}|Pass|PAY_PAY_FILE_Q|Job|APSRD5785|Stn|PAY_PAY_VAR_TST|Table|



|script                                                                                                                                        |
|check|query|select count(*) as count from DW_FILE_QUEUE f where  f.file_nm ='$datfilename' and f.file_typ='TRR'|For|1|And Retry|120|times|true|



!|script     |EtlJobRunner                                                                                           |
|$job_status=|run Job With|${etl_ui_user}|User|${etl_ui_pwd}|Pass|PAY_PAY_TRR|Job|APSRD5785|Stn|PAY_PAY_VAR_TST|Table|



|script                                                                                                                         |
|check|query|select count(*) as count from frmk_stg_fileinfo f where  f.file_name ='$datfilename'|For|1|And Retry|120|times|true|



!|script  |DbTable                                                         |
|query    |select * from frmk_stg_fileinfo  where file_name ='$datfilename'|
|$filekey=|valueofcolumn                     |FILE_KEY                     |



|script                                                                                                                      |
|check|query|select process_sts_key from frmk_stg_fileinfo f where f.file_name ='$datfilename'|For|4|And Retry|120|times|true|


!|script     |DbTable                                                     |
|query       |select sub_cli_sk from d_contr where contr_nbr='${contract}'|
|$sub_cli_sk=|valueofcolumn                  |sub_cli_sk                  |


|Query:Db Table|select * from cms_trr where file_key = $filekey and HIC_NBR='${hicnum1}'|${env}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|FILE_KEY      |CLI_SK                                                                  |SUB_CLI_SK |CS_SRC_DATA_SYS_CD|DERIV_FILE_FREQ_IND|DERIV_FILE_DT        |DERIV_STD_FILE_DT|HIC_NBR   |SURN    |FST_NM    |MIDL_INIT|GDR_CD|DOB                  |FILLER_1|MCAID_STS|CONTR_NBR  |ST_CD|CNTY_CD|DSBL_IND|HSPC_IND|INST_NHC_HCBS_IND|ESRD_IND|TRANS_RPLY_CD|TRANS_TYP_CD|ENTL_TYP_CD|EFF_DT               |WA_IND|PBP_ID|FILLER_2|TRANS_DT             |UI_INIT_CHG_FLG|FILLER_3|TRANS_DTL|DERIV_EFF_DISENRL_DT|DERIV_NEW_ENRL_EFF_DT|DERIV_HIC_NBR|DERIV_DOD|DERIV_HSPC_STRT_DT|DERIV_HSPC_END_DT|DERIV_ESRD_STRT_DT|DERIV_ESRD_END_DT|DERIV_INST_NHC_STRT_DT|DERIV_INST_NHC_END_DT|DERIV_MCAID_STRT_DT|DERIV_MCAID_END_DT|DERIV_PRT_A_END_DT|DERIV_WA_STRT_DT|DERIV_WA_END_DT|DERIV_PRT_A_REINST_DT|DERIV_PRT_B_END_DT|DERIV_PRT_B_REINST_DT|DERIV_NEW_SCC|DERIV_OLD_SCC|DERIV_ATTEMPTED_ENRL_EFF_DT|DERIV_NEW_LOW_INC_PREM_SBSD|DERIV_NEW_LOW_INC_CST_SHR_SBSD|DERIV_PBP_EFF_DT|DERIV_CORR_PRT_D_PREM_RT|DERIV_INFO_CHG_BY_UI_USER_DT|DERIV_MOD_PRT_C_PREM_AMT|DERIV_DMSTR_FCT_EFF_DT|DERIV_DMSTR_FCT_END_DT|DERIV_ESRD_STS_CANC_DT|DERIV_WA_STS_CANC_DT|DERIV_NEW_PREM_SBSD_AMT|DERIV_NEW_LIS_COPAY_AMT|DERIV_DOD_REMV|DERIV_DLS_END_DT|DERIV_TPLNT_FAIL_DT|DERIV_NEW_ZIP_CD|DERIV_PREV_CONTR_POS_DRGEA_IND|DERIV_MSP_COV_TRM_DT|DERIV_MAX_NUNCMO_CALC|DIST_OFC_CD|PREV_PRT_D_PLAN_TROOP_TRNSF|FILLER_4|FILLER_5|SRC_ID     |PREV_PBP_ID|APPL_DT|UI_USER_ORG_DESG|FILLER_6|OUT_OF_AREA_FLG|SEG_NBR|PRT_C_BENFY_PREM|PRT_D_BENFY_PREM|ELEC_TYP|ENRL_SRC|PRT_D_OPTOUT_FLG|PREM_WTHLD_OPT_PRT_C_D|CUM_NBR_OF_UNCOVERED_MO|CREDITABLE_COV_FLG|EMPLR_SBSD_OVRD_FLG|PROC_TMSTMP    |FILLER_7|FILLER_8|RX_ID|RX_GRP|SEC_DRG_INS_FLG|SEC_RX_ID|SEC_RX_GRP|EGHP|PRT_D_LOW_INCM_PREM_SBSD_LVL|LOW_INCM_COPAY_CATGY|LOW_INCM_PRD_EFF_DT|PRT_D_LT_ENRL_PNLTY_AMT|PRT_D_LT_ENRL_PNLTY_WAIV_AMT|PRT_D_LT_ENRL_PNLTY_SBSD_AMT|LOW_INCM_PRT_D_PREM_SBSD_AMT|PRT_D_RX_BIN|PRT_D_RX_PCN|PRT_D_RX_GRP|PRT_D_RX_ID|SEC_RX_BIN|SEC_RX_PCN|DE_MINIMIS_DIFF_AMT|FILLER_9|PRT_A_DEMO_PAY_RT|PRT_B_DEMO_PAY_RT|MSP_STS_FLG|LOW_INCM_PRD_END_DT|LOW_INCM_SBSD_SRC_CD|ENRLEE_TYP_FLG_PBP_LVL|APPL_DT_IND|TRC_SHRT_NM  |SYS_ASGN_TRANS_TRK_ID|PLN_ASGN_TRANS_TRK_ID|REC_TYP|DISENRL_RSN_CD|FA_DEMO_OPT_OUT_FLG|HSPC_PROV_NBR|FILLER_10|END_DT|SBMT_NBR_OF_UNCOVERED_MO|MMP_OPT_OUT_FLG|CLNUP_ID|POS_DRG_EDT_UPDT_DEL_FLG|POS_DRG_EDT_STS|POS_DRG_EDT_CLSS|POS_DRG_EDT_CD|NTFY_DT|IMPL_DT|TRM_DT|FILLER_11|DERIV_IC_MODL_END_DT|IC_MODL_TYP_IND|IC_MODL_END_DT_RESN_CD|IC_MODL_BENFT_STS|DERIV_MCAID_STS_MO|UPDT_MCAID_STS_COMM_RAF_BENFY|DERIV_MSP_STRT_DT|
|$filekey      |$sub_cli_sk                                                             |$sub_cli_sk|CS_DW             |                   |2017-09-14 00:00:00.0|                 |${hicnum1}|WHITAKES|${fst_nm1}|         |1     |1929-01-16 00:00:00.0|        |         |${contract}|46   |260    |        |        |                 |        |035          |11          |           |2016-07-30 00:00:00.0|      |001   |        |2016-09-04 00:00:00.0|0              |        |20160930 |                    |                     |             |         |                  |                 |                  |                 |                      |                     |                   |                  |                  |                |               |                     |                  |                     |             |             |                           |                           |                              |2016-09-30 00:00:00.0      |                        |                            |                        |                      |                      |                      |                    |                       |                       |              |                |                   |                |                              |                    |                     |           |                           |        |        |${contract}|           |       |03              |        |               |       |                |                |        |        |                |                      |                       |                  |                   |03.37.45.209556|        |        |     |      |               |         |          |    |                            |                    |                   |                       |                            |                            |                            |            |            |            |           |          |          |                   |        |                 |                 |           |                   |                    |                      |           |MEMB DECEASED|-1089303039          |                     |T      |              |                   |             |         |      |                        |               |        |                        |               |                |              |       |       |      |         |                    |               |                      |                 |                  |                             |                 |

|Query:Db Table|select * from cms_trr where file_key = $filekey and HIC_NBR='${hicnum2}'|${env}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|FILE_KEY      |CLI_SK                                                                  |SUB_CLI_SK |CS_SRC_DATA_SYS_CD|DERIV_FILE_FREQ_IND|DERIV_FILE_DT        |DERIV_STD_FILE_DT|HIC_NBR   |SURN |FST_NM    |MIDL_INIT|GDR_CD|DOB                  |FILLER_1|MCAID_STS|CONTR_NBR  |ST_CD|CNTY_CD|DSBL_IND|HSPC_IND|INST_NHC_HCBS_IND|ESRD_IND|TRANS_RPLY_CD|TRANS_TYP_CD|ENTL_TYP_CD|EFF_DT               |WA_IND|PBP_ID|FILLER_2|TRANS_DT             |UI_INIT_CHG_FLG|FILLER_3|TRANS_DTL|DERIV_EFF_DISENRL_DT|DERIV_NEW_ENRL_EFF_DT|DERIV_HIC_NBR|DERIV_DOD|DERIV_HSPC_STRT_DT|DERIV_HSPC_END_DT|DERIV_ESRD_STRT_DT|DERIV_ESRD_END_DT|DERIV_INST_NHC_STRT_DT|DERIV_INST_NHC_END_DT|DERIV_MCAID_STRT_DT|DERIV_MCAID_END_DT|DERIV_PRT_A_END_DT|DERIV_WA_STRT_DT|DERIV_WA_END_DT|DERIV_PRT_A_REINST_DT|DERIV_PRT_B_END_DT|DERIV_PRT_B_REINST_DT|DERIV_NEW_SCC|DERIV_OLD_SCC|DERIV_ATTEMPTED_ENRL_EFF_DT|DERIV_NEW_LOW_INC_PREM_SBSD|DERIV_NEW_LOW_INC_CST_SHR_SBSD|DERIV_PBP_EFF_DT|DERIV_CORR_PRT_D_PREM_RT|DERIV_INFO_CHG_BY_UI_USER_DT|DERIV_MOD_PRT_C_PREM_AMT|DERIV_DMSTR_FCT_EFF_DT|DERIV_DMSTR_FCT_END_DT|DERIV_ESRD_STS_CANC_DT|DERIV_WA_STS_CANC_DT|DERIV_NEW_PREM_SBSD_AMT|DERIV_NEW_LIS_COPAY_AMT|DERIV_DOD_REMV|DERIV_DLS_END_DT|DERIV_TPLNT_FAIL_DT|DERIV_NEW_ZIP_CD|DERIV_PREV_CONTR_POS_DRGEA_IND|DERIV_MSP_COV_TRM_DT|DERIV_MAX_NUNCMO_CALC|DIST_OFC_CD|PREV_PRT_D_PLAN_TROOP_TRNSF|FILLER_4|FILLER_5|SRC_ID     |PREV_PBP_ID|APPL_DT|UI_USER_ORG_DESG|FILLER_6|OUT_OF_AREA_FLG|SEG_NBR|PRT_C_BENFY_PREM|PRT_D_BENFY_PREM|ELEC_TYP|ENRL_SRC|PRT_D_OPTOUT_FLG|PREM_WTHLD_OPT_PRT_C_D|CUM_NBR_OF_UNCOVERED_MO|CREDITABLE_COV_FLG|EMPLR_SBSD_OVRD_FLG|PROC_TMSTMP    |FILLER_7|FILLER_8|RX_ID|RX_GRP|SEC_DRG_INS_FLG|SEC_RX_ID|SEC_RX_GRP|EGHP|PRT_D_LOW_INCM_PREM_SBSD_LVL|LOW_INCM_COPAY_CATGY|LOW_INCM_PRD_EFF_DT|PRT_D_LT_ENRL_PNLTY_AMT|PRT_D_LT_ENRL_PNLTY_WAIV_AMT|PRT_D_LT_ENRL_PNLTY_SBSD_AMT|LOW_INCM_PRT_D_PREM_SBSD_AMT|PRT_D_RX_BIN|PRT_D_RX_PCN|PRT_D_RX_GRP|PRT_D_RX_ID|SEC_RX_BIN|SEC_RX_PCN|DE_MINIMIS_DIFF_AMT|FILLER_9|PRT_A_DEMO_PAY_RT|PRT_B_DEMO_PAY_RT|MSP_STS_FLG|LOW_INCM_PRD_END_DT|LOW_INCM_SBSD_SRC_CD|ENRLEE_TYP_FLG_PBP_LVL|APPL_DT_IND|TRC_SHRT_NM   |SYS_ASGN_TRANS_TRK_ID|PLN_ASGN_TRANS_TRK_ID|REC_TYP|DISENRL_RSN_CD|FA_DEMO_OPT_OUT_FLG|HSPC_PROV_NBR|FILLER_10|END_DT|SBMT_NBR_OF_UNCOVERED_MO|MMP_OPT_OUT_FLG|CLNUP_ID|POS_DRG_EDT_UPDT_DEL_FLG|POS_DRG_EDT_STS|POS_DRG_EDT_CLSS|POS_DRG_EDT_CD|NTFY_DT|IMPL_DT|TRM_DT|FILLER_11|DERIV_IC_MODL_END_DT|IC_MODL_TYP_IND|IC_MODL_END_DT_RESN_CD|IC_MODL_BENFT_STS|DERIV_MCAID_STS_MO|UPDT_MCAID_STS_COMM_RAF_BENFY|DERIV_MSP_STRT_DT|
|$filekey      |$sub_cli_sk                                                             |$sub_cli_sk|CS_DW             |                   |2017-09-14 00:00:00.0|                 |${hicnum2}|SMITH|${fst_nm2}|         |1     |1947-07-18 00:00:00.0|        |         |${contract}|46   |260    |        |        |                 |        |036          |21          |Y          |2016-07-31 00:00:00.0|0     |001   |        |2016-09-04 00:00:00.0|0              |        |20160930 |                    |                     |             |         |                  |                 |                  |                 |                      |                     |                   |                  |                  |                |               |                     |                  |                     |             |             |                           |                           |                              |2016-09-30 00:00:00.0      |                        |                            |                        |                      |                      |                      |                    |                       |                       |              |                |                   |                |                              |                    |                     |           |                           |        |        |${contract}|           |       |                |        |N              |       |21.5            |17.5            |S       |        |                |                      |26                     |                  |                   |03.38.46.633529|        |        |     |      |               |         |          |    |                            |                    |                   |8.9                    |0                           |0                           |0                           |            |            |            |           |          |          |0                  |        |                 |                 |           |                   |                    |                      |           |AUTO DISENROLL|-1089290038          |0                    |T      |08            |                   |             |         |      |                        |               |        |                        |               |                |              |       |       |      |         |                    |               |                      |                 |                  |                             |                 |

|script                                                                                                                                        |
|check|query|select count(*) as count from DW_FILE_QUEUE f where  f.file_nm ='$datfilename' and f.file_typ='TRR'|For|0|And Retry|120|times|true|

